"use strict";(self.webpackChunkdocsite=self.webpackChunkdocsite||[]).push([[106],{4957:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>o,contentTitle:()=>d,default:()=>u,frontMatter:()=>a,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"resources/build-images/builders","title":"Builders","description":"A builder is a machine running the Komodo Periphery agent (and usually docker), which is able to handle a RunBuild / BuildRepo command from Komodo core. Any server connected to Komodo can be chosen as the builder for a build.","source":"@site/docs/resources/build-images/builders.md","sourceDirName":"resources/build-images","slug":"/resources/build-images/builders","permalink":"/docs/resources/build-images/builders","draft":false,"unlisted":false,"editUrl":"https://github.com/moghtech/komodo/tree/main/docsite/docs/resources/build-images/builders.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"Pre-build command","permalink":"/docs/resources/build-images/pre-build"},"next":{"title":"Image Versioning","permalink":"/docs/resources/build-images/versioning"}}');var s=n(4848),t=n(8453);const a={},d="Builders",o={},l=[{value:"AWS builder",id:"aws-builder",level:2},{value:"Setup the instance",id:"setup-the-instance",level:3},{value:"Make an AMI from the instance",id:"make-an-ami-from-the-instance",level:3},{value:"Configure security groups / firewall",id:"configure-security-groups--firewall",level:3},{value:"Multi-Platform Builds with Docker Buildx",id:"multi-platform-builds-with-docker-buildx",level:2},{value:"1. Create and use a Buildx builder instance",id:"1-create-and-use-a-buildx-builder-instance",level:3},{value:"2. Make Buildx the default for <code>docker build</code>",id:"2-make-buildx-the-default-for-docker-build",level:3},{value:"3. (Optional) View available builders",id:"3-optional-view-available-builders",level:3},{value:"Platform selection in Komodo",id:"platform-selection-in-komodo",level:3}];function c(e){const i={admonition:"admonition",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",p:"p",pre:"pre",strong:"strong",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(i.header,{children:(0,s.jsx)(i.h1,{id:"builders",children:"Builders"})}),"\n",(0,s.jsx)(i.p,{children:"A builder is a machine running the Komodo Periphery agent (and usually docker), which is able to handle a RunBuild / BuildRepo command from Komodo core. Any server connected to Komodo can be chosen as the builder for a build."}),"\n",(0,s.jsx)(i.p,{children:"Building on a machine running production software is usually not a great idea, as this process can use a lot of system resources. It is better to start up a temporary cloud machine dedicated for the build, then shut it down when the build is finished. Komodo supports AWS EC2 for this task."}),"\n",(0,s.jsx)(i.h2,{id:"aws-builder",children:"AWS builder"}),"\n",(0,s.jsx)(i.p,{children:"Builders are now Komodo resources, and are managed via the core API / can be updated using the UI.\nTo use this feature, you need an AWS EC2 AMI with docker and Komodo Periphery configured to run on system start.\nOnce you create your builder and add the necessary configuration, it will be available to attach to builds."}),"\n",(0,s.jsx)(i.h3,{id:"setup-the-instance",children:"Setup the instance"}),"\n",(0,s.jsx)(i.p,{children:"Create an EC2 instance, and install Docker and Periphery on it."}),"\n",(0,s.jsx)(i.p,{children:"The following script is an example of installing Docker and Periphery onto a Ubuntu/Debian instance:"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-sh",children:"#!/bin/bash\napt update\napt upgrade -y\ncurl -fsSL https://get.docker.com | sh\nsystemctl enable docker.service\nsystemctl enable containerd.service\ncurl -sSL https://raw.githubusercontent.com/moghtech/komodo/main/scripts/setup-periphery.py | HOME=/root python3\nsystemctl enable periphery.service\n"})}),"\n",(0,s.jsx)(i.admonition,{type:"note",children:(0,s.jsx)(i.p,{children:'AWS provides a "user data" feature, which will run a provided script as root. The above can be used with AWS user data\nto provide a hands free setup.'})}),"\n",(0,s.jsx)(i.h3,{id:"make-an-ami-from-the-instance",children:"Make an AMI from the instance"}),"\n",(0,s.jsx)(i.p,{children:"Once the instance is up and running, ssh in and confirm Periphery is running using:"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-sh",children:"sudo systemctl status periphery.service\n"})}),"\n",(0,s.jsx)(i.p,{children:"If it is not, the install hasn't finished and you should wait a bit. It may take 5 minutes or more (all in updating / installing Docker, Periphery is just a 12 MB binary to download)."}),"\n",(0,s.jsxs)(i.p,{children:["Once Periphery is running, you can navigate to the instance in the AWS UI and choose ",(0,s.jsx)(i.code,{children:"Actions"})," -> ",(0,s.jsx)(i.code,{children:"Image and templates"})," -> ",(0,s.jsx)(i.code,{children:"Create image"}),". Just name the image and hit create."]}),"\n",(0,s.jsxs)(i.p,{children:["The AMI will provide a unique id starting with ",(0,s.jsx)(i.code,{children:"ami-"}),", use this with the builder configuration."]}),"\n",(0,s.jsx)(i.h3,{id:"configure-security-groups--firewall",children:"Configure security groups / firewall"}),"\n",(0,s.jsx)(i.p,{children:"The builders will need inbound access on port 8120 from Komodo Core, be sure to add a security group with this rule to the Builder configuration."}),"\n",(0,s.jsx)(i.h2,{id:"multi-platform-builds-with-docker-buildx",children:"Multi-Platform Builds with Docker Buildx"}),"\n",(0,s.jsx)(i.p,{children:"If you need to build Docker images for multiple platforms (such as ARM and x86), Docker Buildx provides an easy way to do this."}),"\n",(0,s.jsxs)(i.p,{children:["Multi-platform builds can take significantly longer than single-platform builds.",(0,s.jsx)(i.br,{}),"\n","When emulating a different architecture (e.g., building ARM images on an x86 host), expect additional time due to QEMU-based emulation."]}),"\n",(0,s.jsx)(i.h3,{id:"1-create-and-use-a-buildx-builder-instance",children:"1. Create and use a Buildx builder instance"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-sh",children:"docker buildx create --name builder --use --bootstrap\n"})}),"\n",(0,s.jsxs)(i.p,{children:["This command creates a new builder named ",(0,s.jsx)(i.code,{children:"builder"})," and sets it as the active builder for the current Docker context."]}),"\n",(0,s.jsx)(i.hr,{}),"\n",(0,s.jsxs)(i.h3,{id:"2-make-buildx-the-default-for-docker-build",children:["2. Make Buildx the default for ",(0,s.jsx)(i.code,{children:"docker build"})]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-sh",children:"docker buildx install\n"})}),"\n",(0,s.jsxs)(i.p,{children:["This replaces the default ",(0,s.jsx)(i.code,{children:"docker build"})," command with Buildx, so all builds automatically use the current builder instance."]}),"\n",(0,s.jsx)(i.hr,{}),"\n",(0,s.jsx)(i.h3,{id:"3-optional-view-available-builders",children:"3. (Optional) View available builders"}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-sh",children:"docker buildx ls\n"})}),"\n",(0,s.jsx)(i.p,{children:"Use this to list all builder instances and check which one is active."}),"\n",(0,s.jsx)(i.hr,{}),"\n",(0,s.jsxs)(i.p,{children:["After these steps, any ",(0,s.jsx)(i.code,{children:"docker build"})," command will use Buildx by default, making it straightforward to create multi-platform images."]}),"\n",(0,s.jsx)(i.hr,{}),"\n",(0,s.jsx)(i.h3,{id:"platform-selection-in-komodo",children:"Platform selection in Komodo"}),"\n",(0,s.jsxs)(i.p,{children:["When building inside ",(0,s.jsx)(i.strong,{children:"Komodo"}),", you can specify the target platforms (e.g., ",(0,s.jsx)(i.code,{children:"linux/amd64"}),", ",(0,s.jsx)(i.code,{children:"linux/arm64"}),') directly in the Komodo UI during build configuration in the build "Extra Args" field.']}),"\n",(0,s.jsx)(i.p,{children:(0,s.jsx)(i.strong,{children:"Example platform string for Extra Args:"})}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{children:"--platform linux/amd64,linux/arm64\n"})})]})}function u(e={}){const{wrapper:i}={...(0,t.R)(),...e.components};return i?(0,s.jsx)(i,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453:(e,i,n)=>{n.d(i,{R:()=>a,x:()=>d});var r=n(6540);const s={},t=r.createContext(s);function a(e){const i=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(i):{...i,...e}},[i,e])}function d(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(t.Provider,{value:i},e.children)}}}]);